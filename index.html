<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Match Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for console visibility
        setLogLevel('Debug');
        
        // --- 1. FIREBASE CONFIGURATION (MANDATORY) ---
        // Your specific configuration is hardcoded here for guaranteed deployment success on GitHub Pages.
        const firebaseConfig = {
            apiKey: "AIzaSyDecFpmgdHZfYA562wuksV-03VCxOw6PdI",
            authDomain: "matchscorelive-6bfe9.firebaseapp.com",
            projectId: "matchscorelive-6bfe9",
            storageBucket: "matchscorelive-6bfe9.firebasestorage.app",
            messagingSenderId: "870565113347",
            appId: "1:870565113347:web:85ca2f2a5b73023b89e836",
            measurementId: "G-YBNQRZ4NJM"
        };
        
        // Since we are not in the Canvas environment, we must define these manually.
        const appId = 'matchscorelive-6bfe9'; 

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // State variables (UI elements)
        const matchState = {
            docId: null,
            players: { A: 'Player A', B: 'Player B' },
            scores: { A: 0, B: 0 },
            raceTo: 7,
            status: 'Setup' // 'Setup', 'Active', 'Finished'
        };

        const elements = {};

        function getElements() {
            elements.matchSetup = document.getElementById('match-setup');
            elements.scorer = document.getElementById('scorer');
            elements.log = document.getElementById('match-log');
            elements.scoreA = document.getElementById('score-a');
            elements.scoreB = document.getElementById('score-b');
            elements.nameA = document.getElementById('player-name-a');
            elements.nameB = document.getElementById('player-name-b');
            elements.inputNameA = document.getElementById('input-name-a');
            elements.inputNameB = document.getElementById('input-name-b');
            elements.inputRaceTo = document.getElementById('input-race-to');
            elements.errorMessage = document.getElementById('error-message');
            elements.modal = document.getElementById('winner-modal');
            elements.modalText = document.getElementById('winner-modal-text');
            elements.matchIdDisplay = document.getElementById('match-id-display');
            elements.logToggleBtn = document.getElementById('log-toggle-btn');
            elements.matchLogContainer = document.getElementById('match-log-container');
        }

        // --- 2. FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously, as the custom token is unavailable on static hosting
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Authenticated anonymously with UID:", userId);
                
                isAuthReady = true; 
                // Start listening to data once auth is ready
                if (matchState.docId) {
                    startRealtimeListener(matchState.docId);
                }

            } catch (error) {
                console.error("Firebase Initialization or Authentication Failed:", error);
                displayError(`Error: Cannot connect to Firebase database. Check console for details.`);
                isAuthReady = true; // Mark as ready to avoid endless loading
            }
        }

        // --- 3. DATA AND UI LOGIC ---

        function getMatchDocRef(matchId) {
            // Public data path: /artifacts/{appId}/public/data/matches/{matchId}
            return doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
        }

        function getLogCollectionRef(matchId) {
            // Log path: /artifacts/{appId}/public/data/matches/{matchId}/log
            return collection(db, 'artifacts', appId, 'public', 'data', 'matches', matchId, 'log');
        }

        function displayError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.remove('hidden');
        }

        function renderMatch(data) {
            if (data.status === 'Setup') {
                elements.matchSetup.classList.remove('hidden');
                elements.scorer.classList.add('hidden');
                elements.modal.classList.add('hidden');
                elements.logToggleBtn.classList.add('hidden');
                displayError('');
                elements.matchIdDisplay.textContent = 'Match ID: None';
                return;
            }

            // Hide setup and show scorer
            elements.matchSetup.classList.add('hidden');
            elements.scorer.classList.remove('hidden');
            elements.logToggleBtn.classList.remove('hidden');
            
            // Update matchState
            Object.assign(matchState, data);

            // Update UI elements
            elements.nameA.textContent = data.players.A;
            elements.nameB.textContent = data.players.B;
            elements.scoreA.textContent = data.scores.A;
            elements.scoreB.textContent = data.scores.B;
            elements.matchIdDisplay.textContent = `Match ID: ${matchState.docId}`;
            
            // Check for game end
            if (data.status === 'Finished') {
                const winner = data.scores.A > data.scores.B ? data.players.A : data.players.B;
                elements.modalText.textContent = `${winner} wins the race to ${data.raceTo}!`;
                elements.modal.classList.remove('hidden');
            } else {
                elements.modal.classList.add('hidden');
            }
        }
        
        function toggleLog() {
            if (elements.matchLogContainer.classList.contains('hidden')) {
                elements.matchLogContainer.classList.remove('hidden');
                elements.logToggleBtn.textContent = 'Hide Match Log';
            } else {
                elements.matchLogContainer.classList.add('hidden');
                elements.logToggleBtn.textContent = 'Show Match Log';
            }
        }

        function startRealtimeListener(matchId) {
            if (!db || !isAuthReady) return;

            const matchRef = getMatchDocRef(matchId);
            
            // 1. Listen to the main match document
            const unsubscribeMatch = onSnapshot(matchRef, (docSnap) => {
                if (docSnap.exists()) {
                    renderMatch(docSnap.data());
                } else {
                    console.log("Match document not found. Returning to setup.");
                    renderMatch({ status: 'Setup' });
                }
            }, (error) => {
                console.error("Error listening to match:", error);
                displayError("Error connecting to database (Check security rules/network).");
            });

            // 2. Listen to the log
            const logQ = query(getLogCollectionRef(matchId), orderBy('timestamp', 'desc'), limit(15));
            const unsubscribeLog = onSnapshot(logQ, (querySnapshot) => {
                let logHtml = '';
                querySnapshot.forEach((doc) => {
                    const log = doc.data();
                    const time = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleTimeString() : '...';
                    logHtml += `<p class="text-sm ${log.type === 'win' ? 'text-green-400' : 'text-yellow-400'}">
                        [${time}] ${log.message}
                    </p>`;
                });
                elements.log.innerHTML = logHtml;
            }, (error) => {
                 console.error("Error listening to log:", error);
            });
            
            // Note: In a larger app, you'd save and use these unsubscribe functions.
            return { unsubscribeMatch, unsubscribeLog };
        }

        // --- 4. ACTION HANDLERS ---
        
        document.getElementById('start-match-btn').addEventListener('click', async () => {
            if (!db || !isAuthReady) {
                displayError("Database connection not ready. Please wait a moment or check console.");
                return;
            }

            const nameA = elements.inputNameA.value.trim() || 'Player 1';
            const nameB = elements.inputNameB.value.trim() || 'Player 2';
            const raceTo = parseInt(elements.inputRaceTo.value, 10);
            
            if (isNaN(raceTo) || raceTo < 1) {
                displayError("Race To score must be a number greater than 0.");
                return;
            }

            displayError(''); // Clear error message
            
            // Generate a simple match ID. 
            const matchId = `match_${crypto.randomUUID().substring(0, 8)}`; 
            const matchRef = getMatchDocRef(matchId);
            
            const initialData = {
                players: { A: nameA, B: nameB },
                scores: { A: 0, B: 0 },
                raceTo: raceTo,
                status: 'Active',
                createdAt: serverTimestamp(),
                createdBy: userId,
            };

            try {
                await setDoc(matchRef, initialData);
                matchState.docId = matchId; // Set the active document ID
                
                // Update URL for sharing
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('matchId', matchId);
                window.history.pushState({path: newUrl.href}, '', newUrl.href);

                startRealtimeListener(matchId);
            } catch (error) {
                console.error("Error creating match:", error);
                displayError("Could not start match. Database write failed.");
            }
        });

        document.getElementById('reset-match-btn').addEventListener('click', async () => {
             // Clear the matchId from URL and reload to go back to setup
             const newUrl = new URL(window.location.href);
             newUrl.searchParams.delete('matchId');
             window.location.href = newUrl.href; 
        });

        async function updateScore(player, type) {
            if (!db || matchState.status === 'Setup') return;
            
            const matchRef = getMatchDocRef(matchState.docId);
            const playerKey = player; 
            const playerName = matchState.players[playerKey];
            const logCollection = getLogCollectionRef(matchState.docId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(matchRef);
                    if (!docSnap.exists()) {
                        throw "Match does not exist!";
                    }
                    
                    const currentData = docSnap.data();
                    let currentScore = currentData.scores[playerKey];
                    let newScore, logMessage;
                    let newStatus = currentData.status;

                    if (type === 'win') {
                        newScore = currentScore + 1;
                        logMessage = `${playerName} won a rack. New score: ${newScore}.`;
                    } else if (type === 'undo') {
                        newScore = Math.max(0, currentScore - 1);
                        logMessage = `UNDO: Score for ${playerName} reduced. New score: ${newScore}.`;
                    } else {
                        return; // Invalid type
                    }

                    // Determine the new status based on score change
                    if (type === 'win' && newScore >= currentData.raceTo) {
                         newStatus = 'Finished';
                    } else if (currentData.status === 'Finished' && type === 'undo' && newScore < currentData.raceTo) {
                         // Undoing a winning score reverts game state
                         newStatus = 'Active';
                    }

                    // Update the match document
                    const newScores = { ...currentData.scores, [playerKey]: newScore };
                    transaction.update(matchRef, {
                        scores: newScores,
                        status: newStatus,
                    });

                    // Add log entry
                    transaction.set(doc(logCollection), {
                        message: logMessage,
                        type: type,
                        timestamp: serverTimestamp(),
                        user: userId,
                    });
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                displayError("Score update failed. Please check the console.");
            }
        }
        
        // --- 5. INITIALIZATION CALL ---

        window.onload = function() {
            getElements();
            initFirebase();
            
            // Attach event listeners
            document.getElementById('start-match-btn').addEventListener('click', () => updateScore('A', 'win'));
            document.getElementById('win-a-btn').addEventListener('click', () => updateScore('A', 'win'));
            document.getElementById('undo-a-btn').addEventListener('click', () => updateScore('A', 'undo'));
            document.getElementById('win-b-btn').addEventListener('click', () => updateScore('B', 'win'));
            document.getElementById('undo-b-btn').addEventListener('click', () => updateScore('B', 'undo'));
            document.getElementById('log-toggle-btn').addEventListener('click', toggleLog);
            
             // Check URL for existing match ID (for sharing/rejoining)
            const params = new URLSearchParams(window.location.search);
            const urlMatchId = params.get('matchId');
            if (urlMatchId) {
                matchState.docId = urlMatchId;
                // Listener will start once auth is ready
            } else {
                 renderMatch({ status: 'Setup' });
            }
        };

    </script>
    <style>
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        }
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans flex flex-col items-center p-4">

    <!-- Header & Title -->
    <div class="w-full max-w-4xl text-center mb-6">
        <h1 class="text-4xl font-extrabold text-blue-400 text-shadow">Pool Match</h1>
        <p id="error-message" class="text-red-500 font-semibold mt-2 hidden"></p>
        
        <!-- Controls Bar -->
        <div class="flex justify-between items-center mt-4 px-4 sm:px-0">
            <p class="text-sm text-gray-500" id="match-id-display">Match ID: None</p>
            <button id="log-toggle-btn" class="hidden px-3 py-1 bg-gray-700 hover:bg-gray-600 text-sm text-gray-300 rounded-lg transition duration-200">
                Show Match Log
            </button>
        </div>
    </div>

    <!-- Winner Modal (Hidden by Default) -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center custom-shadow border-2 border-green-500">
            <h2 class="text-4xl font-bold text-green-400 mb-4">MATCH OVER!</h2>
            <p id="winner-modal-text" class="text-2xl text-gray-200 mb-6"></p>
            <button id="reset-match-btn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-lg transition duration-200">
                Start New Match
            </button>
        </div>
    </div>

    <!-- Match Setup Screen -->
    <div id="match-setup" class="w-full max-w-md bg-gray-800 p-6 rounded-xl custom-shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Setup Match</h2>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <input type="text" id="input-name-a" placeholder="Player 1 Name" value="Player 1"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
            <input type="text" id="input-name-b" placeholder="Player 2 Name" value="Player 2"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
            <input type="number" id="input-race-to" placeholder="Race To" value="7"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
        </div>
        <button id="start-match-btn"
                class="w-full p-4 bg-blue-500 hover:bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200 custom-shadow">
            Start Match
        </button>
    </div>

    <!-- Main Scorer Interface (Hidden by Default) -->
    <div id="scorer" class="hidden w-full max-w-4xl flex flex-col lg:flex-row gap-6">
        
        <!-- Score Columns (Always Visible) -->
        <div class="flex flex-1 gap-6">
            
            <!-- Player A Column -->
            <div class="flex-1 bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col items-center border-t-4 border-blue-500">
                <h2 id="player-name-a" class="text-2xl font-bold text-blue-300 mb-4">Player 1</h2>
                <div id="score-a" class="text-8xl font-black text-white mb-6 text-shadow">0</div>
                
                <!-- Action Buttons for A -->
                <div class="grid grid-cols-2 gap-3 w-full">
                    <button id="win-a-btn"
                            class="col-span-2 p-4 bg-green-600 hover:bg-green-700 text-white font-bold text-xl rounded-xl shadow-md transition duration-200 custom-shadow">
                        Win Rack (+1)
                    </button>
                    <button id="undo-a-btn"
                            class="col-span-2 p-3 bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-semibold rounded-xl shadow-md transition duration-200 custom-shadow text-sm">
                        Undo Rack (-1)
                    </button>
                </div>
            </div>

            <!-- Player B Column -->
            <div class="flex-1 bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col items-center border-t-4 border-blue-500">
                <h2 id="player-name-b" class="text-2xl font-bold text-blue-300 mb-4">Player 2</h2>
                <div id="score-b" class="text-8xl font-black text-white mb-6 text-shadow">0</div>
                
                <!-- Action Buttons for B -->
                <div class="grid grid-cols-2 gap-3 w-full">
                    <button id="win-b-btn"
                            class="col-span-2 p-4 bg-green-600 hover:bg-green-700 text-white font-bold text-xl rounded-xl shadow-md transition duration-200 custom-shadow">
                        Win Rack (+1)
                    </button>
                     <button id="undo-b-btn"
                            class="col-span-2 p-3 bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-semibold rounded-xl shadow-md transition duration-200 custom-shadow text-sm">
                        Undo Rack (-1)
                    </button>
                </div>
            </div>
        </div>

        <!-- Log Column (Collapsible) -->
        <div id="match-log-container" class="lg:w-1/3 w-full hidden lg:block bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col">
            <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2">Match Log (15 Racks)</h2>
            <div id="match-log" class="space-y-2 overflow-y-auto flex-grow h-64 lg:h-auto text-gray-400">
                <!-- Log entries will be inserted here by JavaScript -->
            </div>
            <p class="text-xs text-gray-600 pt-4 border-t border-gray-700 mt-4">Log is read-only.</p>
        </div>
    </div>
</body>
</html>
