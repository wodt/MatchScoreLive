<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Match Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for console visibility
        setLogLevel('Debug');
        
        // --- 1. FIREBASE CONFIGURATION (MANDATORY) ---
        // This application runs in a hosted environment that provides the Firebase config and auth token.
        // The __firebase_config variable is the stringified JSON of your provided credentials.
        
        // YOUR FIREBASE CONFIGURATION IS INJECTED HERE:
        const firebaseConfigString = '{"apiKey":"AIzaSyDecFpmgdHZfYA562wuksV-03VCxOw6PdI","authDomain":"matchscorelive-6bfe9.firebaseapp.com","projectId":"matchscorelive-6bfe9","storageBucket":"matchscorelive-6bfe9.firebasestorage.app","messagingSenderId":"870565113347","appId":"1:870565113347:web:85ca2f2a5b73023b89e836","measurementId":"G-YBNQRZ4NJM"}';
        
        const firebaseConfig = JSON.parse(firebaseConfigString);
        
        // The app ID and initial auth token are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // State variables (UI elements)
        const matchState = {
            docId: null,
            players: { A: 'Player A', B: 'Player B' },
            scores: { A: 0, B: 0 },
            raceTo: 7,
            status: 'Setup' // 'Setup', 'Active', 'Finished'
        };

        const elements = {};

        function getElements() {
            elements.matchSetup = document.getElementById('match-setup');
            elements.scorer = document.getElementById('scorer');
            elements.log = document.getElementById('match-log');
            elements.scoreA = document.getElementById('score-a');
            elements.scoreB = document.getElementById('score-b');
            elements.nameA = document.getElementById('player-name-a');
            elements.nameB = document.getElementById('player-name-b');
            elements.inputNameA = document.getElementById('input-name-a');
            elements.inputNameB = document.getElementById('input-name-b');
            elements.inputRaceTo = document.getElementById('input-race-to');
            elements.errorMessage = document.getElementById('error-message');
            elements.modal = document.getElementById('winner-modal');
            elements.modalText = document.getElementById('winner-modal-text');
        }

        // --- 2. FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up authentication listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with UID:", userId);
                    } else {
                        // This handles the case if initialAuthToken is null or expired
                        userId = crypto.randomUUID(); // Use a temp ID for anonymous sign-in failure
                        console.log("Signed in anonymously or using temporary ID:", userId);
                    }
                    isAuthReady = true;
                    // Start listening to data once auth is ready
                    if (matchState.docId) {
                        startRealtimeListener(matchState.docId);
                    }
                });

                // Sign in using the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Authentication Failed:", error);
                displayError(`Error: Firebase Config Missing/Invalid. (Check console for details).`);
                isAuthReady = true; // Mark as ready to avoid endless loading
            }
        }

        // --- 3. DATA AND UI LOGIC ---

        function getMatchDocRef(matchId) {
            // Using a public artifact path so the match is shared and accessible.
            // path: /artifacts/{appId}/public/data/matches/{matchId}
            return doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
        }

        function getLogCollectionRef(matchId) {
            // path: /artifacts/{appId}/public/data/matches/{matchId}/log
            return collection(db, 'artifacts', appId, 'public', 'data', 'matches', matchId, 'log');
        }

        function displayError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.remove('hidden');
        }

        function renderMatch(data) {
            if (data.status === 'Setup') {
                elements.matchSetup.classList.remove('hidden');
                elements.scorer.classList.add('hidden');
                elements.modal.classList.add('hidden');
                displayError('');
                return;
            }

            // Hide setup and show scorer
            elements.matchSetup.classList.add('hidden');
            elements.scorer.classList.remove('hidden');
            
            // Update matchState
            Object.assign(matchState, data);

            // Update UI elements
            elements.nameA.textContent = data.players.A;
            elements.nameB.textContent = data.players.B;
            elements.scoreA.textContent = data.scores.A;
            elements.scoreB.textContent = data.scores.B;
            
            // Check for game end
            if (data.status === 'Finished') {
                const winner = data.scores.A > data.scores.B ? data.players.A : data.players.B;
                elements.modalText.textContent = `${winner} wins the race to ${data.raceTo}!`;
                elements.modal.classList.remove('hidden');
            } else {
                elements.modal.classList.add('hidden');
            }
        }

        async function startRealtimeListener(matchId) {
            if (!db || !isAuthReady) return;

            const matchRef = getMatchDocRef(matchId);
            
            // 1. Listen to the main match document
            onSnapshot(matchRef, (docSnap) => {
                if (docSnap.exists()) {
                    renderMatch(docSnap.data());
                } else {
                    console.log("Match document not found. Returning to setup.");
                    renderMatch({ status: 'Setup' });
                }
            }, (error) => {
                console.error("Error listening to match:", error);
                displayError("Error connecting to database (Check security rules/network).");
            });

            // 2. Listen to the log
            const logQ = query(getLogCollectionRef(matchId), orderBy('timestamp', 'desc'), limit(15));
            onSnapshot(logQ, (querySnapshot) => {
                let logHtml = '';
                querySnapshot.forEach((doc) => {
                    const log = doc.data();
                    logHtml += `<p class="text-sm ${log.type === 'win' ? 'text-green-400' : 'text-yellow-400'}">
                        [${new Date(log.timestamp?.toDate()).toLocaleTimeString() || '...'}] ${log.message}
                    </p>`;
                });
                elements.log.innerHTML = logHtml;
            }, (error) => {
                 console.error("Error listening to log:", error);
            });
        }

        // --- 4. ACTION HANDLERS ---
        
        document.getElementById('start-match-btn').addEventListener('click', async () => {
            if (!db || !isAuthReady) {
                displayError("Database connection not ready. Check console for errors.");
                return;
            }

            const nameA = elements.inputNameA.value.trim() || 'Player A';
            const nameB = elements.inputNameB.value.trim() || 'Player B';
            const raceTo = parseInt(elements.inputRaceTo.value, 10);
            
            if (isNaN(raceTo) || raceTo < 1) {
                displayError("Race To score must be a number greater than 0.");
                return;
            }

            displayError(''); // Clear error message
            
            // Generate a simple match ID. For a complex app, this would be a user-input field.
            const matchId = `match_${crypto.randomUUID().substring(0, 8)}`; 
            const matchRef = getMatchDocRef(matchId);
            
            const initialData = {
                players: { A: nameA, B: nameB },
                scores: { A: 0, B: 0 },
                raceTo: raceTo,
                status: 'Active',
                createdAt: serverTimestamp(),
                createdBy: userId,
            };

            try {
                await setDoc(matchRef, initialData);
                matchState.docId = matchId; // Set the active document ID
                startRealtimeListener(matchId);
            } catch (error) {
                console.error("Error creating match:", error);
                displayError("Could not start match. Database write failed.");
            }
        });

        document.getElementById('reset-match-btn').addEventListener('click', async () => {
             // Simple hard refresh to go back to setup and clear state
             window.location.reload(); 
        });

        async function updateScore(player, type) {
            if (!db || matchState.status !== 'Active') return;
            
            const matchRef = getMatchDocRef(matchState.docId);
            const playerKey = player; // 'A' or 'B'
            const playerName = matchState.players[playerKey];
            const logCollection = getLogCollectionRef(matchState.docId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(matchRef);
                    if (!docSnap.exists()) {
                        throw "Match does not exist!";
                    }
                    
                    const currentData = docSnap.data();
                    let currentScore = currentData.scores[playerKey];
                    let newScore, logMessage;
                    let newStatus = 'Active';

                    if (type === 'win') {
                        newScore = currentScore + 1;
                        logMessage = `${playerName} won a rack. New score: ${newScore}.`;
                    } else if (type === 'undo') {
                        newScore = Math.max(0, currentScore - 1);
                        logMessage = `UNDO: Score for ${playerName} reduced. New score: ${newScore}.`;
                    } else {
                        return; // Invalid type
                    }

                    // Check for game completion/reversion
                    if (newScore >= currentData.raceTo) {
                        if (newScore > currentData.scores[playerKey]) { // Only if score increased
                             newStatus = 'Finished';
                        } else if (newScore < currentData.scores[playerKey]) { // Only if score decreased
                             // If scores dropped below raceTo, revert status to Active
                             newStatus = 'Active';
                        }
                    } 
                    
                    if (type === 'undo' && currentData.status === 'Finished' && newScore < currentData.raceTo) {
                         // Critical: Undoing a winning score reverts game state
                         newStatus = 'Active';
                    } else if (type === 'win' && newScore >= currentData.raceTo) {
                         newStatus = 'Finished';
                    }

                    // Update the match document
                    const newScores = { ...currentData.scores, [playerKey]: newScore };
                    transaction.update(matchRef, {
                        scores: newScores,
                        status: newStatus,
                    });

                    // Add log entry
                    transaction.set(doc(logCollection), {
                        message: logMessage,
                        type: type,
                        timestamp: serverTimestamp(),
                        user: userId,
                    });
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                displayError("Score update failed. Please check the console.");
            }
        }
        
        // --- 5. INITIALIZATION CALL ---

        window.onload = function() {
            getElements();
            initFirebase();
            
            // Attach score update listeners
            document.getElementById('win-a-btn').addEventListener('click', () => updateScore('A', 'win'));
            document.getElementById('undo-a-btn').addEventListener('click', () => updateScore('A', 'undo'));
            document.getElementById('win-b-btn').addEventListener('click', () => updateScore('B', 'win'));
            document.getElementById('undo-b-btn').addEventListener('click', () => updateScore('B', 'undo'));
            
             // Check URL for existing match ID (for sharing/rejoining)
            const params = new URLSearchParams(window.location.search);
            const urlMatchId = params.get('matchId');
            if (urlMatchId) {
                matchState.docId = urlMatchId;
                // Listener will start once auth is ready
            } else {
                 renderMatch({ status: 'Setup' });
            }
        };

    </script>
    <style>
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
        }
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans flex flex-col items-center p-4">

    <!-- Header & Title -->
    <div class="w-full max-w-lg text-center mb-6">
        <h1 class="text-4xl font-extrabold text-blue-400 text-shadow">Pool Match</h1>
        <p id="error-message" class="text-red-500 font-semibold mt-2 hidden"></p>
    </div>

    <!-- Match ID (for debugging/sharing) -->
    <p class="text-sm text-gray-500 mb-4" id="match-id-display">Match ID: nineballMatch_A</p>

    <!-- Winner Modal (Hidden by Default) -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center custom-shadow border-2 border-green-500">
            <h2 class="text-4xl font-bold text-green-400 mb-4">MATCH OVER!</h2>
            <p id="winner-modal-text" class="text-2xl text-gray-200 mb-6"></p>
            <button id="reset-match-btn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-lg transition duration-200">
                Start New Match
            </button>
        </div>
    </div>

    <!-- Match Setup Screen -->
    <div id="match-setup" class="w-full max-w-md bg-gray-800 p-6 rounded-xl custom-shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-300">Setup Match</h2>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <input type="text" id="input-name-a" placeholder="Player 1 Name" value="Player 1"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
            <input type="text" id="input-name-b" placeholder="Player 2 Name" value="Player 2"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
            <input type="number" id="input-race-to" placeholder="Race To" value="7"
                   class="col-span-1 p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 border-none">
        </div>
        <button id="start-match-btn"
                class="w-full p-4 bg-blue-500 hover:bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg transition duration-200 custom-shadow">
            Start Match
        </button>
    </div>

    <!-- Main Scorer Interface (Hidden by Default) -->
    <div id="scorer" class="hidden w-full max-w-4xl grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Player A Column -->
        <div class="col-span-1 bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col items-center border-t-4 border-blue-500">
            <h2 id="player-name-a" class="text-2xl font-bold text-blue-300 mb-4">Player A</h2>
            <div id="score-a" class="text-8xl font-black text-white mb-6 text-shadow">0</div>
            
            <!-- Action Buttons for A (2x2 Grid) -->
            <div class="grid grid-cols-2 gap-3 w-full">
                <button id="win-a-btn"
                        class="col-span-2 p-4 bg-green-600 hover:bg-green-700 text-white font-bold text-xl rounded-xl shadow-md transition duration-200 custom-shadow">
                    Win Rack (+1)
                </button>
                <button id="undo-a-btn"
                        class="col-span-2 p-3 bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-semibold rounded-xl shadow-md transition duration-200 custom-shadow text-sm">
                    Undo Rack (-1)
                </button>
            </div>
        </div>

        <!-- Log Column -->
        <div class="col-span-1 bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col">
            <h2 class="text-xl font-semibold text-gray-300 mb-4 border-b border-gray-700 pb-2">Match Log (15 Racks)</h2>
            <div id="match-log" class="space-y-2 overflow-y-auto flex-grow h-64 text-gray-400">
                <!-- Log entries will be inserted here by JavaScript -->
            </div>
            <p class="text-xs text-gray-600 pt-4 border-t border-gray-700 mt-4">Log is read-only.</p>
        </div>

        <!-- Player B Column -->
        <div class="col-span-1 bg-gray-800 p-6 rounded-xl custom-shadow flex flex-col items-center border-t-4 border-blue-500">
            <h2 id="player-name-b" class="text-2xl font-bold text-blue-300 mb-4">Player B</h2>
            <div id="score-b" class="text-8xl font-black text-white mb-6 text-shadow">0</div>
            
            <!-- Action Buttons for B (2x2 Grid) -->
            <div class="grid grid-cols-2 gap-3 w-full">
                <button id="win-b-btn"
                        class="col-span-2 p-4 bg-green-600 hover:bg-green-700 text-white font-bold text-xl rounded-xl shadow-md transition duration-200 custom-shadow">
                    Win Rack (+1)
                </button>
                 <button id="undo-b-btn"
                        class="col-span-2 p-3 bg-yellow-600 hover:bg-yellow-700 text-gray-900 font-semibold rounded-xl shadow-md transition duration-200 custom-shadow text-sm">
                    Undo Rack (-1)
                </button>
            </div>
        </div>
    </div>
</body>
</html>
